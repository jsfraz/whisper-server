name: Deploy to VPS

# Workflow for automatic deployment of an application to VPS when pushing to the main branch

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Download full history for potential change comparisons

      - name: Setup SSH and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          # Upload files to the server
          envs: GITHUB_SHA
          script_stop: true  # Stop executing further commands on error
          script: |
            # Check if project directory exists
            if [ -d "${{ secrets.PROJECT_PATH }}" ]; then
              echo "Project directory exists, updating repository..."
              cd ${{ secrets.PROJECT_PATH }}
              git pull origin main
            else
              echo "Project directory doesn't exist, cloning repository..."
              mkdir -p $(dirname "${{ secrets.PROJECT_PATH }}")
              git clone https://github.com/jsfraz/whisper-server.git "${{ secrets.PROJECT_PATH }}"
              cd ${{ secrets.PROJECT_PATH }}
            fi
            
            echo "Creating data directory if it doesn't exist..."
            mkdir -p data
      
      - name: Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script_stop: true  # Stops executing further commands in case of error
          script: |
            cd ${{ secrets.PROJECT_PATH }}

            # Create .env.prod file
            echo "Creating .env.prod file..."
            cat > .env.prod << EOL
            SERVER_URL=${{ secrets.SERVER_URL }}
            SQLITE_PASSWORD=${{ secrets.SQLITE_PASSWORD }}
            VALKEY_PASSWORD=${{ secrets.VALKEY_PASSWORD }}
            ADMIN_MAIL=${{ secrets.ADMIN_MAIL }}
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
            ACCESS_TOKEN_SECRET=${{ secrets.ACCESS_TOKEN_SECRET }}
            REFRESH_TOKEN_SECRET=${{ secrets.REFRESH_TOKEN_SECRET }}
            WS_ACCESS_TOKEN_SECRET=${{ secrets.WS_ACCESS_TOKEN_SECRET }}
            EOL

            # Create Firebase JSON file directly in data directory
            echo "Creating Firebase JSON file..."
            echo "${{ secrets.FIREBASE_JSON_BASE64 }}" | base64 --decode > data/firebase.json

            # Stop running containers
            echo "Stopping current containers..."
            docker compose -f docker-compose.prod.yml --env-file .env.prod down

            # Build and start containers
            echo "Building and starting containers..."
            docker compose -f docker-compose.prod.yml --env-file .env.prod up -d --build

            # Wait for the service to start
            echo "Waiting for service to start..."
            sleep 10
      
      - name: Notify Deployment Status
        # This step will only run if the previous step fails
        if: failure()
        run: echo "Deployment failed! Please check logs for details."